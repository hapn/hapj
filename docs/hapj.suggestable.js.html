<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>JSDoc: Source: ui/hapj.suggestable.js</title>

<script src="scripts/prettify/prettify.js"> </script>
<script src="scripts/prettify/lang-css.js"> </script>
<!--[if lt IE 9]>
<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
<link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

<h1 class="page-title">Source: ui/hapj.suggestable.js</h1>




    
    <section>
        <article>
            <pre class="prettyprint source"><code>/** 
 * Copyright (c) 2014, Jiehun.com.cn Inc. All Rights Reserved
 * @author dengxiaolong@jiehun.com.cn
 * @date 2014-09-24
 * @version 2.0 
 * @brief 使元素可以自动提供建议
 * @example 
$('#suggestable').suggestable({
	items:['qq.com', 'hotmail.com', '163.com', '126.com'],
	onSelect: function(text) {
		this.value = text;
	},
	autoSearch:true,
	searchPrefix: '@'
});

 **/
!function($){
	'use strict';
	
	var defaults = {
		width:'auto',
		height:0,
		className:'suggestion',
		selectedClass:'on', // 选中后的样式名
		items:null,        // 获取的数据，可以是数组，或者函数，或者网址
		onWrapperData:null, // 封装给远程调用url的数据
		autoSearch: false,   // 是否自动搜索
		searchPrefix: '',     // 搜索的匹配前缀，比如邮箱匹配可加@
		getItem:null         // 从items里边获取到显示的文字，如果设置，必须是一个函数，且返回字符串
	},
	generateItems = function(items, getItem){
		var ret = [];
		if (!getItem) {
			$.each(items, function(key, item){
				ret.push('&lt;li>' + item + '&lt;/li>');
			});
		} else {
			$.each(items, function(key, item){
				ret.push('&lt;li>' + getItem(item) + '&lt;/li>');
			});
		}
		return ret.join('');
	},
	KEY_DOWN = 40, 
	KEY_UP = 38,
	KEY_TAB = 9,
	KEY_ENTER = 13,
	KEY_ESC = 27;
	
	/**
	 * 为一个可输入的组件提供自动化建议框。
	 * @class jQuery.fn.suggestable
	 * @param {Object} 配置参数，目前支持的有：
	 * &lt;dl>
	 *  &lt;dt>items&lt;/dt>
	 *  &lt;dd>用来提供建议的列表，可以是网址、数组、函数。函数要求返回数组对象&lt;/dd>
	 *  &lt;dt>width&lt;/dt>
	 *  &lt;dd>宽度，单位为px，默认为auto&lt;/dd>
	 *  &lt;dt>height&lt;/dt>
	 *  &lt;dd>高度，默认为auto&lt;/dd>
	 *  &lt;dt>className&lt;/dt>
	 *  &lt;dd>建议框的样式名称，默认为suggestion&lt;/dd>
	 *  &lt;dt>selectedClass&lt;/dt>
	 *  &lt;dd>建议框条目被选中的样式名称，默认为on&lt;/dd>
	 *  &lt;dt>onWrapperData&lt;/dt>
	 *  &lt;dd>如果items为远程网址，此函数被用来将远程网址获取的内容封装成数组&lt;/dd>
	 *  &lt;dt>autoSearch&lt;/dt>
	 *  &lt;dd>是否自动搜索，只有在items为数组时才会有用。默认为false&lt;/dd>
	 *  &lt;dt>searchPrefix&lt;/dt>
	 *  &lt;dd>自动搜索时的匹配前缀，默认为空。只有autoSearch为true时才有用。此选项在做邮箱匹配时非常有用，可设置为@&lt;/dd>
	 *  &lt;dt>onSelect&lt;em>function(text)&lt;/em>&lt;/dt>
	 *  &lt;dd>当选择了菜单的时候发生的事件&lt;br/>
	 *    	&lt;em>text&lt;/em> 选择的菜单的文字
	 *  &lt;/dd>
	 *  &lt;dt>beforeShow&lt;em>function(value)&lt;/dt>
	 *  &lt;dd>在显示提示列表之前的事件。如果返回false，则不显示提示菜单&lt;br/>
	 *  	&lt;em>value&lt;/em> 文本框里边的值
	 *  &lt;/dd>
	 * &lt;/dl>
	 * @example 
$('#suggestable').suggestable({
	items:['qq.com', 'hotmail.com', '163.com', '126.com'],
	onSelect: function(text) {
		this.value = text;
	},
	autoSearch:true,
	searchPrefix: '@'
});

	 */
	$.fn.suggestable = function(options) {
		var conf = $.extend({}, defaults), self = this;
		$.extend(conf, options);
		
		if (!conf.items) {
			throw new Error('hapj.suggestable items is required');
		}
		
		var pos = this.offset();
		var elem = $('div');
		elem.css({
			display:'none',
			position:'absolute',
			left:pos.left + 'px',
			top:(pos.top + self.height(true)) + 'px',
			width:conf.width ? (isNaN(conf.width) ? conf.width : conf.width + 'px') : self.width(true) + 'px',
			height:conf.height ? conf.height + 'px' : 'auto'
		}).attr({
			'class':conf.className
		}).html('&lt;ul>&lt;/ul>');
		
		var suggestion = new Suggestion(elem);
		suggestion.selectedClass = conf.selectedClass;
		
		document.body.appendChild(elem[0]);
		var items;
		if (typeof conf.items == 'string') { // 是网址
			var url = conf.items;
			if (!conf.onWrapperData) {
				conf.onWrapperData = function(ret) {
					return ret.data.suggestion;
				};
			}
			conf.items = function(callback) {
				$.ajax({
					url:url.replace('{value}', self.attr('value')),
					method:'get',
					success:function(ret) {
						suggestion.items = conf.onWrapperData(ret);
						callback.call(null, suggestion.items);
					}
				});
			};
		} else if ($.isArray(conf.items)) {
			items = conf.items;
			conf.items = function(callback){
				if (!conf.autoSearch) {
					callback.call(null, items);
					return;
				}
				var ret = [], value = self[0].value;
				if (conf.searchPrefix) {
					var pos = value.indexOf(conf.searchPrefix);
					if (pos >= 0) {
						var str = value.substring(pos + 1);
						$.each(items, function(i, s) {
							if (!str) {
								ret.push(value + s);
							} else {
								var p = s.indexOf(str);
								if (p > -1) {
									ret.push(value.substring(0, pos) + conf.searchPrefix + s);
								}
							}
						});
					}
				} else {
					$.each(items, function(i, s) {
						if (s.indexOf(value) >= 0) {
							ret.push(s);
						}
					});
				}
				suggestion.items = ret;
				callback.call(null, ret);
			};
		} else if (typeof conf.items == 'function') {
			items = conf.items;
			conf.items = function(callback) {
				suggestion.items = items.call(self[0], self[0].value);
				callback.call(null, suggestion.items);
			};
		}
		
		suggestion.onClick = function() {
			conf.onSelect && conf.onSelect.call(self[0], conf.getItem ? suggestion.getItem() : suggestion.get());
			suggestion.hide();
		};
		this.attr('autocomplete', 'off')
		.on('keydown', function(e) {
			switch(e.keyCode) {
				case KEY_TAB:
				case KEY_ENTER:
				case KEY_DOWN:
				case KEY_UP:
					return false;
			}
		})
		.on('keyup', function(e){
			if (suggestion._show) {
				switch(e.keyCode) {
					case KEY_TAB:
					case KEY_ENTER:
						suggestion.onClick();
						return false;
					case KEY_DOWN:
						suggestion.next();
						return false;
					case KEY_UP:
						suggestion.prev();
						return false;
					case KEY_ESC:
						suggestion.hide();
						return false;
				}
			}
			if (!conf.beforeShow || conf.beforeShow.call(self, self[0].value) !== false) {
				conf.items(function(items){
					suggestion.html(generateItems(items, conf.getItem));
					suggestion.show();
				});
			}
		});
	};
	
	function Suggestion(elem) {
		this.elem = elem;
		var self = this;
		this.elem.on('li', 'mouseover', function(e) {
			var index = e.target.getAttribute('index');
			self._index = index;
			self._select(index);
		}).on('li', 'click', function() {
			self.onClick && self.onClick.call(null, self.get(true));
		});
		this._index = 0;
		this._show = false;
	}
	Suggestion.prototype = {
		selectedClass: 'on',
		items:null,
		getItem: function() {
			return this.items[this._index];
		},
		next: function() {
			this._index++;
			if (this._index >= this._tags.length) {
				this._index = 0;
			}
			this._select(this._index);
		},
		prev: function() {
			this._index--;
			if (this._index &lt; 0) {
				this._index = this._tags.length - 1;
			}
			this._select(this._index);
		},
		get: function(html) {
			html = !!html;
			return html ? this._tags[this._index].innerHTML : $(this._tags[this._index]).text();
		},
		_select: function(index) {
			if (index >= this._tags.length) {
				return;
			}
			this._tags.removeClass(this.selectedClass);
			this._tags[index].className = this.selectedClass;
		},
		show: function() {
			if (this._tags.length > 0) {
				this._show = true;
				this.elem.show();
			} else {
				this.hide();
			}
		},
		hide: function() {
			this._show = false;
			this.elem.hide();
		},
		html: function(html) {
			this.elem.tag('ul').html(html).tag('li').each(function(i){
				this.setAttribute('index', i);
			});
			this._tags = this.elem.tag('li');
			this._index = 0;
			this._select(0);
		}
	};
}(jQuery);</code></pre>
        </article>
    </section>




</div>

<nav>
<h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="hapj.html">hapj</a></li><li><a href="hapj.ajax.html">ajax</a></li><li><a href="hapj.array.html">array</a></li><li><a href="hapj.browser.html">browser</a></li><li><a href="hapj.cache.html">cache</a></li><li><a href="hapj.conf.html">conf</a></li><li><a href="hapj.date.html">date</a></li><li><a href="hapj.hook.html">hook</a></li><li><a href="hapj.json.html">json</a></li><li><a href="hapj.log.html">log</a></li><li><a href="hapj.object.html">object</a></li><li><a href="hapj.page.html">page</a></li><li><a href="hapj.string.html">string</a></li><li><a href="hapj.ui.html">ui</a></li><li><a href="hapj.ui.ajaxable.html">ajaxable</a></li><li><a href="hapj.ui.node.html">node</a></li><li><a href="jQuery.html">jQuery</a></li><li><a href="jQuery.fn.html">fn</a></li><li><a href="jQuery.fn.ajaxable.html">ajaxable</a></li><li><a href="jQuery.fn.floatable.html">floatable</a></li><li><a href="jQuery.fn.lazyload.html">lazyload</a></li><li><a href="jQuery.fn.menuable.html">menuable</a></li><li><a href="jQuery.fn.selectable.html">selectable</a></li><li><a href="jQuery.fn.suggestable.html">suggestable</a></li><li><a href="jQuery.fn.switchable.html">switchable</a></li></ul>
</nav>

<br clear="both">

<footer>
Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Wed Sep 24 2014 14:15:23 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
